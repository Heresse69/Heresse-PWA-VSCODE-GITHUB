<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>üì± Diagnostic Mobile - Heresse PWA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #ffffff;
            padding: 20px;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .diagnostic-container {
            max-width: 100%;
            margin: 0 auto;
        }
        
        h1 {
            color: #10b981;
            margin-bottom: 20px;
            font-size: 1.5rem;
            text-align: center;
        }
        
        .test-section {
            background: #333;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #10b981;
        }
        
        .test-title {
            color: #60a5fa;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        .result {
            background: #1f2937;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            margin: 8px 0;
            word-break: break-all;
        }
        
        .success { color: #10b981; }
        .warning { color: #fbbf24; }
        .error { color: #ef4444; }
        
        button {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 5px;
            width: 100%;
        }
        
        button:active {
            background: #059669;
        }
        
        .app-link {
            background: #3b82f6;
            text-decoration: none;
            display: block;
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            margin: 20px 0;
        }
        
        .logs {
            background: #000;
            color: #00ff00;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        @media (max-width: 600px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="diagnostic-container">
        <h1>üì± Diagnostic Mobile PWA</h1>
        
        <div class="test-section">
            <div class="test-title">üåê Informations Navigateur</div>
            <div class="result" id="browser-info"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">üì± Caract√©ristiques Mobile</div>
            <div class="result" id="mobile-info"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">üîß Service Worker Status</div>
            <div class="result" id="sw-status"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">üì¶ Cache Status</div>
            <div class="result" id="cache-status"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">üåç Connectivit√© R√©seau</div>
            <div class="result" id="network-status"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">üìä Test de Chargement React</div>
            <div class="result" id="react-test"></div>
            <button onclick="testReactApp()">üß™ Tester React App</button>
        </div>
        
        <div class="test-section">
            <div class="test-title">üöÄ Actions de Diagnostic</div>
            <div class="grid">
                <button onclick="clearAllData()">üßπ Vider Cache</button>
                <button onclick="testConnectivity()">üåê Test R√©seau</button>
                <button onclick="reloadPage()">üîÑ Recharger</button>
                <button onclick="goToMainApp()">üì± App Principale</button>
            </div>
        </div>
        
        <div class="test-section">
            <div class="test-title">üìã Logs en Temps R√©el</div>
            <div class="logs" id="real-time-logs"></div>
            <button onclick="clearLogs()">üóëÔ∏è Vider Logs</button>
        </div>
        
        <a href="/" class="app-link">
            ‚Ü©Ô∏è Retour √† l'Application Principale
        </a>
    </div>

    <script>
        let logs = document.getElementById('real-time-logs');
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            logs.innerHTML += `\n${prefix} [${timestamp}] ${message}`;
            logs.scrollTop = logs.scrollHeight;
        }
        
        // Capturer toutes les erreurs
        window.addEventListener('error', (e) => {
            addLog(`ERROR: ${e.message} at ${e.filename}:${e.lineno}`, 'error');
        });
        
        window.addEventListener('unhandledrejection', (e) => {
            addLog(`PROMISE ERROR: ${e.reason}`, 'error');
        });
        
        // Diagnostic initial
        function runDiagnostics() {
            addLog('üöÄ D√©but du diagnostic mobile');
            
            // Informations navigateur
            const browserInfo = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                screenWidth: screen.width,
                screenHeight: screen.height,
                innerWidth: window.innerWidth,
                innerHeight: window.innerHeight,
                devicePixelRatio: window.devicePixelRatio || 1
            };
            
            document.getElementById('browser-info').innerHTML = Object.entries(browserInfo)
                .map(([key, value]) => `${key}: ${value}`)
                .join('<br>');
            
            // Caract√©ristiques mobile
            const mobileInfo = {
                isMobile: /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
                isStandalone: window.matchMedia('(display-mode: standalone)').matches,
                isPWA: window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches,
                hasTouch: 'ontouchstart' in window,
                orientation: screen.orientation ? screen.orientation.angle : 'unknown',
                safeAreaTop: 'env(safe-area-inset-top)' in document.documentElement.style,
                viewport: document.querySelector('meta[name="viewport"]')?.content || 'none'
            };
            
            document.getElementById('mobile-info').innerHTML = Object.entries(mobileInfo)
                .map(([key, value]) => `${key}: ${value}`)
                .join('<br>');
            
            // Service Worker
            checkServiceWorker();
            
            // Cache
            checkCacheStatus();
            
            // R√©seau
            checkNetworkStatus();
            
            addLog('‚úÖ Diagnostic initial termin√©');
        }
        
        async function checkServiceWorker() {
            try {
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    const activeWorker = await navigator.serviceWorker.ready;
                    
                    document.getElementById('sw-status').innerHTML = `
                        Support√©: ‚úÖ<br>
                        Registrations: ${registrations.length}<br>
                        √âtat: ${activeWorker.active ? 'Actif' : 'Inactif'}<br>
                        Scope: ${activeWorker.scope}<br>
                        Script: ${activeWorker.active?.scriptURL || 'N/A'}
                    `;
                    
                    addLog(`SW: ${registrations.length} registration(s), √©tat: ${activeWorker.active ? 'actif' : 'inactif'}`, 'success');
                } else {
                    document.getElementById('sw-status').innerHTML = 'Service Workers non support√©s ‚ùå';
                    addLog('SW: Non support√©', 'error');
                }
            } catch (error) {
                document.getElementById('sw-status').innerHTML = `Erreur: ${error.message}`;
                addLog(`SW Error: ${error.message}`, 'error');
            }
        }
        
        async function checkCacheStatus() {
            try {
                const cacheNames = await caches.keys();
                let totalSize = 0;
                let totalEntries = 0;
                
                for (const name of cacheNames) {
                    const cache = await caches.open(name);
                    const keys = await cache.keys();
                    totalEntries += keys.length;
                }
                
                document.getElementById('cache-status').innerHTML = `
                    Caches: ${cacheNames.length}<br>
                    Noms: ${cacheNames.join(', ') || 'Aucun'}<br>
                    Entr√©es: ${totalEntries}
                `;
                
                addLog(`Cache: ${cacheNames.length} cache(s), ${totalEntries} entr√©es`, 'success');
            } catch (error) {
                document.getElementById('cache-status').innerHTML = `Erreur: ${error.message}`;
                addLog(`Cache Error: ${error.message}`, 'error');
            }
        }
        
        function checkNetworkStatus() {
            const networkInfo = {
                online: navigator.onLine,
                connection: navigator.connection ? {
                    effectiveType: navigator.connection.effectiveType,
                    downlink: navigator.connection.downlink,
                    rtt: navigator.connection.rtt
                } : 'Non disponible'
            };
            
            document.getElementById('network-status').innerHTML = `
                En ligne: ${networkInfo.online ? '‚úÖ' : '‚ùå'}<br>
                Type: ${networkInfo.connection.effectiveType || 'N/A'}<br>
                Vitesse: ${networkInfo.connection.downlink || 'N/A'} Mbps<br>
                Latence: ${networkInfo.connection.rtt || 'N/A'} ms
            `;
            
            addLog(`R√©seau: ${networkInfo.online ? 'En ligne' : 'Hors ligne'}`, networkInfo.online ? 'success' : 'error');
        }
        
        async function testReactApp() {
            addLog('üß™ Test de chargement React...');
            
            try {
                const startTime = Date.now();
                const response = await fetch('/');
                const html = await response.text();
                const loadTime = Date.now() - startTime;
                
                const hasReact = html.includes('react');
                const hasRoot = html.includes('root');
                const hasManifest = html.includes('manifest');
                
                document.getElementById('react-test').innerHTML = `
                    <span class="success">‚úÖ Fetch r√©ussi (${loadTime}ms)</span><br>
                    React d√©tect√©: ${hasReact ? '‚úÖ' : '‚ùå'}<br>
                    Root div: ${hasRoot ? '‚úÖ' : '‚ùå'}<br>
                    Manifest: ${hashasManifest ? '‚úÖ' : '‚ùå'}<br>
                    Taille HTML: ${html.length} caract√®res
                `;
                
                addLog(`React test: Succ√®s en ${loadTime}ms`, 'success');
                
                // Test direct du JavaScript
                const scriptTest = document.createElement('div');
                scriptTest.id = 'react-mount-test';
                document.body.appendChild(scriptTest);
                
                setTimeout(() => {
                    if (window.React) {
                        addLog('React library d√©tect√©e dans window', 'success');
                    } else {
                        addLog('React library NON d√©tect√©e', 'error');
                    }
                }, 1000);
                
            } catch (error) {
                document.getElementById('react-test').innerHTML = `<span class="error">‚ùå Erreur: ${error.message}</span>`;
                addLog(`React test Error: ${error.message}`, 'error');
            }
        }
        
        async function clearAllData() {
            addLog('üßπ Nettoyage complet...');
            
            try {
                // Supprimer caches
                const cacheNames = await caches.keys();
                for (const name of cacheNames) {
                    await caches.delete(name);
                    addLog(`Cache supprim√©: ${name}`, 'success');
                }
                
                // D√©senregistrer SW
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (const registration of registrations) {
                        await registration.unregister();
                        addLog(`SW d√©senregistr√©: ${registration.scope}`, 'success');
                    }
                }
                
                // Vider storage
                localStorage.clear();
                sessionStorage.clear();
                addLog('Storage vid√©', 'success');
                
                addLog('‚úÖ Nettoyage termin√© - Rechargement dans 2s...', 'success');
                setTimeout(() => location.reload(), 2000);
                
            } catch (error) {
                addLog(`Erreur nettoyage: ${error.message}`, 'error');
            }
        }
        
        async function testConnectivity() {
            addLog('üåê Test de connectivit√©...');
            
            const tests = [
                { name: 'App principale', url: '/' },
                { name: 'Manifest', url: '/manifest.json' },
                { name: 'SW Dev', url: '/sw-dev.js' },
                { name: 'Icone', url: '/icons/favicon.svg' }
            ];
            
            for (const test of tests) {
                try {
                    const start = Date.now();
                    const response = await fetch(test.url);
                    const time = Date.now() - start;
                    addLog(`${test.name}: ${response.status} (${time}ms)`, response.ok ? 'success' : 'error');
                } catch (error) {
                    addLog(`${test.name}: ERREUR ${error.message}`, 'error');
                }
            }
        }
        
        function reloadPage() {
            addLog('üîÑ Rechargement de la page...');
            setTimeout(() => location.reload(true), 500);
        }
        
        function goToMainApp() {
            addLog('üì± Redirection vers app principale...');
            setTimeout(() => window.location.href = '/', 500);
        }
        
        function clearLogs() {
            logs.innerHTML = '';
            addLog('üìã Logs vid√©s');
        }
        
        // Lancer le diagnostic au chargement
        document.addEventListener('DOMContentLoaded', runDiagnostics);
        
        // Actualiser les infos r√©seau p√©riodiquement
        setInterval(checkNetworkStatus, 10000);
    </script>
</body>
</html>
